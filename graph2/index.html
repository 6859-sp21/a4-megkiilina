<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<style>
    @font-face{
        font-family: 'JetBrains Mono';
        src: url('https://raw.githubusercontent.com/JetBrains/JetBrainsMono/master/fonts/webfonts/JetBrainsMono-Regular.woff2') format('woff2'),
             url('https://raw.githubusercontent.com/JetBrains/JetBrainsMono/master/fonts/ttf/JetBrainsMono-Regular.ttf') format('truetype');
    }

    body {
        margin: 0px auto;
        font-family: "JetBrains Mono";
        font-size: 15pt;
        color: #e0e0e0;
    }

    h1 {
        margin-top: 100px;
        margin-bottom:100px;
        font-size: 42pt;
        text-decoration: underline;
        text-decoration-style: dotted;
        text-decoration-color: #535359;
    }
    h2 {
        font-size: 80pt;
        opacity: 0.55;
    }
    h4 {
      display: inline;
      font-size: 7pt;
    }

    svg {
    font-family: Sans-Serif, Arial;
    }
    
    .line {
      stroke-width: 2;
      fill: none;
    }     

    #authors {
        font-size: 16pt;
        text-align: left;
        margin-bottom: 100px;
        font-weight: bolder;
    }

    .body-copy {
        margin-bottom: 20px;
    }

    img {
        margin-top: 40px;
        margin-bottom: 10px;
    }

    .container-1 {
      width: 100%;
      display: flex;
      justify-content: space-between;
      background-color: #1d1e38;
    }

    .legend text.label  {
      fill: grey;
      font-size: 8pt;
    }
    .legend{
      position: absolute;
      bottom:0;
      right: 0;
    }

    #map-container {
      position: fixed;
      font-size: 10pt;
      font-weight: bolder;
      text-align: center;
      right: 0px;
      width: 65%;
      height: 100%;
      margin: 0px;
    }

    .a {
      font-size: 5pt;
    }

    #map-svg {
      display: inline-block;
    	position: absolute;
    	top: 0;
    	left: 0;
      width: 100%;
      height: 100%;
      float: right;
    }

    #sections {
        width: 30%;
        left: 0px;
        padding-left: 2em;
        padding-right: 2em;
    }

    #sections > div {
        opacity: .2;
        margin-bottom: 200px;
    }

    #sections > div:last-child {
        margin-bottom: 90px;
    }

    #sections > div.graph-scroll-active {
        opacity: 1;
    }

    #graph {
        margin-top: 100px;
        width: 300px;
        position: -webkit-sticky;
        position: sticky;
        top: 0px;
    }

    .mono {
        font-family: monospace;
    }

</style>

<script src="lib/d3v4+jetpack.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>

<script src="main6.js" defer></script>

<div id='container' class='container-1'>
    <div id='sections'>
      <div id='intro'>
        <h1>Atlas of<br> Telecomm- unication Technology<br> in the 20C</h1>
        <div id="authors">
            Kii Kang<br> Elina Oikonomaki<br> Megan Prakash <br>
        </div>
        <div class="body-copy">
            Humanity worldwide is continually developing new technology. Innovations such
            as the telephone, TV, and internet permanently change global communication, and
            adoption of novel technology is very disproportionate between countries.

            Throughout the history of technology adoption documented in our dataset, a
            country's GDP is strongly correlated with how quickly it is able to adopt
            its use of a technology per capita. A particularly strong trend in the past
            hundred years is that the world superpowers Russia, China, and the USA dominate in both GDP and technology adoption.

            However, this trend is disrupted in the era of 1980-2010.
            Scroll to see how worldwide adoption of communications technology changed
            throughout that time.
        </div><br>
        <div style="font-size: 12pt; font-style: italic;">Dataset:
            <a href="https://github.com/datasets/historical-adoption-of-technology" target="_blank">
                Historical Adoption of Technology </a> with discussion
            <a href="https://www.nber.org/system/files/working_papers/w15319/w15319.pdf" target="_blank">here.</a>
        </div>
      </div>


      </br>

        <div>
            <h2>1877</h2>
            <h3>Invention of the Telephone</h3>
            1876 saw the invention of the telephone by Alexander Graham Bell in the USA, who later visited
            Japan personally in 1877 to demonstrate the technology. [2]
            From 1876, the USA led the world in telephone use, reaching as many as 180 million telephones in 1980
            while the rest of the world adopted telephones much more slowly. In particular, Japan had
            the next most telephones, at 48 million when the U.S. reached its peak.
            <div>1877</div>
              <button onclick="turnOnGDP(1)">GDP</button>
              <button onclick="turnOnYEAR(1)">Year</button>   
              <div id="svg1"></div>
        </div>

        <div>
            <h2>1920</h2>
            <h3>Invention of the Radio</h3>
            Radio was patented in 1896 by Guglielmo Marconi, and the world began to develop applications for
            this novel long-range communication technology. In particular, the 1910s saw the development
            of entertainment broadcast stations, radio communications for aircraft, and even the early stages
            of television, using radio to broadcast images.
            <div>1920</div>
              <button onclick="turnOnGDP(2)">GDP</button>
              <button onclick="turnOnYEAR(2)">Year</button>   
              <div id="svg2"></div>
        </div>
        <div>
            <h2>1980</h2>
            <h3>First commercial radio broadcast</h3>
            “On November 2, 1920, station KDKA made the nation's first commercial broadcast
            (a term coined by Conrad himself). They chose that date because it was election day,
             and the power of radio was proven when people could hear the results of the Harding-Cox
              presidential race before they read about it in the newspaper.” [1]
              <a href = "http://www.pbs.org/wgbh/aso/databank/entries/dt20ra.html" target = "_blank">Information about radio.</a>
            <div>1980</div>
              <button onclick="turnOnGDP(3)">GDP</button>
              <button onclick="turnOnYEAR(3)">Year</button>  
              <div id="svg3"></div>
        <div>
            <h2>1991</h2>
            <h3>The Fall of the USSR</h3>
            The fall of the USSR in 1991 causes a distinct anomaly in the trend of world superpowers dominating
            technology acquisition. The USSR's radio usage drastically falls post-1990, coinciding with a jump
            upwards in China's usage.
            <div>1991</div>
              <button onclick="turnOnGDP(4)">GDP</button>
              <button onclick="turnOnYEAR(4)">Year</button>  
              <div id="svg4"></div>
        </div>

        <div>
            <h2>1991</h2>
            <h3>The Fall of the USSR</h3>
            The fall of the USSR in 1991 causes a distinct anomaly in the trend of world superpowers dominating
            technology acquisition. The USSR's radio usage drastically falls post-1990, coinciding with a jump
            upwards in China's usage.
            <div>5th SVG</div>
              <button onclick="turnOnGDP(5)">GDP</button>
              <button onclick="turnOnYEAR(5)">Year</button>  
              <div id="svg5"></div>
        </div>

        <div>
            <h2>1991</h2>
            <h3>The Fall of the USSR</h3>
            The fall of the USSR in 1991 causes a distinct anomaly in the trend of world superpowers dominating
            technology acquisition. The USSR's radio usage drastically falls post-1990, coinciding with a jump
            upwards in China's usage.
            <div>6th SVG</div>
              <button onclick="turnOnGDP(6)">GDP</button>
              <button onclick="turnOnYEAR(6)">Year</button>  
              <div id="svg6"></div>
        </div>

        <div>  </div> <!-- this is a placeholder to keep the graph in place -->

    </div>
    <div id='map-container'>
        <svg id="map-svg"></svg>
    </div>

</div>


<div style="height:300px"></div>

<!-- Each 'container' div corresponds to one graph -->
<!-- See the js at the bottom of this file for where a d3 svg is assigned to .container-1 -->

<script src="lib/d3v4+jetpack.js"></script>
<script src="lib/graph-scroll.js"></script>
<script>

    var oldWidth = 0

    function render() {
        if (oldWidth == innerWidth) return
        oldWidth = innerWidth

        let width = document.getElementById("map-container").offsetWidth,
            height = document.getElementById("map-container").offsetHeight;

        // const coord = {"center": [[0, 60], [-6, 40], [-6, 40], [18, 36], [21, 60], [-6, 37], [150, 90]],
        //     "scale": [width/4, 500, 500, 600, 600, 500, 400],
        //     "rotate": [[-20, 0], [90, 0], [90, 0], [-120, 0], [0, 0], [-110, 0], [20, 0]]};

        const coord = {"center": [[0, 60], [0, 60], [0, 60], [0, 60], [0, 60], [0, 60], [-10, 50], [0, 60], [-6, 40], [18, 36], [21, 60], [-6, 37], [150, 90]],
            "scale": [width/4, width/4, width/4, width/4, width/4, width/4, width/4, width/2, 1000, 1200, 1200, 1000, 400],
            "rotate": [[-20, 0],[-20, 0],[-20, 0], [-20, 0], [-20, 0], [-20, 0], [-20, 0], [-20, 0], [90, 0], [90, 0], [-120, 0], [0, 0], [-110, 0], [20, 0]]};

        const countriesHighlighted = [[],
                           ["Germany"],
                           ["China", "Germany", "India", "Japan", "Russia", "United States"],
                           ["United States"],
                           ["China", "Germany", "India", "Japan", "Russia", "United States"]];
        const yearSeq = [1995, 1877, 1990, 1927, 1927, 1920, 1983, 1983];
        const techSeq = ["Cellphone","Telephone","Telephone","Telephone","Telephone", "Radio", "Radio", "Cellphone"];

        // const countryColorCode = {"United States": "pink", "China": "green", "India": "red", "Russia": "purple", "Japan": "blue", "Germany": "brown"};

        //global vars
        let worldmap = d3.select("svg");
        let path = d3.geoPath();
        let techDisplayed;
        let yearDisplayed;
        let max;
        // tooltip interaction
        let tooltip = d3.select("#map-container")
          .append("div")
          .style("position", "absolute")
          .style("visibility", "hidden")
          .style("width", "90px")
          .style("height", "70px")
          .style("padding-top", "20px")
          .style("border-style", "solid")
          .style("border-radius", "50%")
          .style("background", "white")
          .style("font-weight", "bold")
          .style("color", "black");



        let colorEncoding = d3.map();
        let colorScale = d3.scaleThreshold();
        // Load external data and boot.text(d.properties["name"])
        d3.queue()
            .defer(d3.json, "world.geojson")
            .await(ready);

        function ready(error, topo) {
            // D3 projections
            // https://sodocumentation.net/d3-js/topic/9001/d3-projections
            let projection = d3.geoAlbers()
                .scale(coord["scale"][0])
                .center(coord["center"][0])
                .rotate(coord["rotate"][0])
                .parallels([65, 65])
                .translate([width / 2, height / 2 + 50]);

            let zoomExtent = function (sectionIndex) {
                console.log(sectionIndex + 'th section active');
                // if (sectionIndex === 0) return;
                // if (sectionIndex >= countries.length) return;

                projection.center(coord["center"][sectionIndex]);
                projection.scale(coord["scale"][sectionIndex]);
                projection.rotate(coord["rotate"][sectionIndex]);

                d3.selectAll("path")
                    .transition("zoom")
                    .duration(2000)
                    .attr("d", d3.geoPath()
                        .projection(projection)
                    )
                    //highlight countries where event has taken place(optional?)
                    // .filter(d => countriesHighlighted[sectionIndex].includes(d.properties["name"]))
                    // .transition()
                    // .duration(1500)
                    // .attr("fill", (d, i) => {return countryColorCode[d.properties["name"]] || "red";})
                    // .transition()
                    // .duration(1500)
                    // .attr("fill", d => {
                    //   return colorScale(colorEncoding.get(d.properties["name"]) || 0);
                    // })
            }

            let fillCountries = function (sectionIndex){
                techDisplayed = techSeq[sectionIndex].toString();
                yearDisplayed = yearSeq[sectionIndex];
                console.log(techDisplayed + " in " + yearDisplayed);

                d3.queue()
                  .defer(d3.csv, "aggregation/Historical_Agg_Cleaned.csv", function(d){
                      max = Math.max(d[techDisplayed]);
                      return { year : +d.Year, country_name : d.Country, Cellphone : +d.Cellphone, Internetuser: +d.Internetuser, Radio: +d.Radio, Telephone: +d.Telephone }
                    },
                    function(data){
                      let dataFilteredByYear = data.filter(function(d) {
                        return d.year === yearDisplayed;
                      })
                      colorEncoding.clear();
                      dataFilteredByYear.forEach(function(d){
                        colorEncoding.set(d.country_name, d[techDisplayed]);
                      })
                      console.log(colorEncoding);
                      colorScale = d3.scaleThreshold()
                          .domain([1, max/5000, max/500, max/50, max/5, max])
                          .range(["#1d1e38", "#333345", "#535359", "#a3a087", "#c4c19f", "#dddbab", "#fffede"])
                      d3.selectAll("path")
                        .transition()
                        .duration(1500)
                        .attr("fill", d => {
                          return colorScale(colorEncoding.get(d.properties["name"]) || 0) ;
                    })
                    })
                    .await(ready);

            }

            let createLegend = function() {
              // https://d3-legend.susielu.com/#color-examples
              max = 1000000000;
              console.log(max);
              var legendScale = d3.scaleLog()
                  .domain([1,max/100000, max/10000, max/1000, max/100, max/10, max])
                  .range(["#1d1e38", "#333345", "#535359", "#a3a087", "#c4c19f", "#dddbab", "#fffede", "fff"]);

              var legendSvg = d3.select("svg");
              legendSvg.append("g")
                .attr("class", "legend")
                .attr("transform", "translate(30,25)");

              var logLegend = d3.legendColor()
                  .cells([10, 100, 1000, 10000, 100000, 1000000, 10000000, 100000000, 1000000000])
                  .shapePadding(0)
                  .shapeWidth(width/10)
                  .shapeHeight(5)
                  .orient("horizontal")
                  .labels(['10', '100', '1K', '10K', '100K', '1M', '10M', '100M', '1B'])
                  .scale(legendScale);

              legendSvg.select(".legend")
                .call(logLegend);

            }

            let mouseOver = function (d) {
                if(d3.active("zoom")) return;
                d3.selectAll(".Country")
                    .style("opacity", .5)
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr('stroke-width', 2.5)
                    .style("opacity", 1)
                    return tooltip
                    .text(d.properties["name"])
                    .style("visibility", "visible");
            }

            let mouseLeave = function (d) {
                if(d3.active("zoom")) return;
                d3.selectAll(".Country")
                    .attr('stroke-width', .5)
                    .style("opacity", 1)
                d3.select(this)
                    .attr('stroke-width', .5)
                    .style("opacity", 1)
                    return tooltip
                    .style("visibility", "hidden");
            }

            var mapVis = worldmap.append("g")
                .selectAll("path")
                .data(topo.features)
                .enter()
                .append("path")
                .attr("stroke", "white")
                .attr('stroke-width', .5)
                .attr("class", d => { return "Country" } )
                .attr("d", d3.geoPath()
                    .projection(projection)
                )
                .on("mouseover", mouseOver )
                .on("mouseout", mouseLeave )
                .on("mousemove", function(d){
                  let tooltipNo = colorEncoding.get(d.properties["name"]) || 0;
                  let tooltipText = tooltipNo.toString();
                  if (tooltipNo > 1000000){
                    tooltipText = (Math.round(tooltipNo/100000)/10).toString() + "M"
                  } else if (tooltipNo > 1000){
                    tooltipText = (Math.round(tooltipNo/100)/10).toString() + "K"
                  }
                  let mouseY = d3.mouse(this)[1]-110;
                  if(d3.mouse(this)[1] <100){mouseY = d3.mouse(this)[1]+20}
                  return tooltip
                    .style("top", mouseY + "px" )
                    .style("left",(d3.mouse(this)[0]-45)+"px")
                    .html(d.properties["name"] + "<br/>" + "<h4>" + tooltipText + '<br/>' + techDisplayed + 's' + "</h4>")
                    .style("visibility", "visible");})


            var mapHandler = d3.graphScroll()
            .container(d3.select(".container-1"))
            .graph(d3.selectAll('#map-container'))
            .eventId('mapId') // namespace for events
            .sections(d3.selectAll('.container-1 #sections > div'))
            .on("active", function(i) { zoomExtent(i), fillCountries(i), createLegend() })

        }

        // I'm Graph #1
        // var gs = d3.graphScroll()
        //     .container(d3.select('.container-1'))
        //     .graph(d3.selectAll('container-1 #graph'))
        //     .eventId('mapID')  // namespace for scroll and resize events
        //     .sections(d3.selectAll('.container-1 #sections > div'))
        //     .on('active', function (i) {
        //         var pos = [{cx: width - r, cy: r},
        //             {cx: r, cy: r},
        //             {cx: width - r, cy: height - r},
        //             {cx: width / 2, cy: height / 2}][i]
        //
        //         circle.transition().duration(1000)
        //             .attrs(pos)
        //             .transition()
        //             .style('fill', colors[i])
        //     })



        // d3.select('#source')
        //     .styles({'margin-bottom': window.innerHeight - 450 + 'px', padding: '100px'})
    }

    render()
    d3.select(window).on('resize', render)


</script>
